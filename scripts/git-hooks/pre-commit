#!/bin/bash
#
# Pre-commit hook to protect data files
# 
# This hook warns users if data files have been modified
# and ensures they're backed up before committing.
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ðŸ”’ Data Protection Check"
echo "========================"

# Check if data files are being committed (they shouldn't be due to .gitignore)
DATA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^data/.*\.(db|sqlite|sqlite3)$" || true)

if [ ! -z "$DATA_FILES" ]; then
    echo -e "${RED}âš  Warning: Database files detected in commit:${NC}"
    echo "$DATA_FILES"
    echo ""
    echo -e "${YELLOW}Database files should not be committed to git.${NC}"
    echo "They are ignored via .gitignore. Please remove them from staging:"
    echo "  git reset HEAD data/*.db"
    exit 1
fi

# Check if data directory exists and has files
if [ -d "data" ]; then
    DB_COUNT=$(find data -name "*.db" -o -name "*.sqlite" -o -name "*.sqlite3" 2>/dev/null | wc -l)
    if [ $DB_COUNT -gt 0 ]; then
        echo -e "${GREEN}âœ“ Found $DB_COUNT database file(s) in data/ directory${NC}"
        
        # Create a backup before commit (optional but recommended)
        if [ -f "scripts/protect_data.py" ]; then
            echo "Creating pre-commit backup..."
            python scripts/protect_data.py backup pre-commit >/dev/null 2>&1
        fi
    fi
fi

# Success
echo -e "${GREEN}âœ“ Data protection check passed${NC}"
exit 0
