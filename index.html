<!DOCTYPE html>
<!-- Version: 2026-02-08-0740 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        .progress-bar { transition: width 0.5s ease-in-out; }
        .modal-content { max-height: 85vh; }
        .agent-status-online { color: #10b981; }
        .agent-status-offline { color: #ef4444; }
        .agent-status-busy { color: #f59e0b; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-busy { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-red {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .pulse-red { animation: pulse-red 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <h1 class="text-3xl font-bold text-gray-800">Task Status Tracker</h1>
                <span id="ruto-status-badge" class="text-sm font-medium px-3 py-1 bg-gray-100 rounded-full">ðŸ—¿ Ruto: Initializing...</span>
            </div>
            <div class="relative">
                <button onclick="toggleNotifications()" class="relative p-2 bg-white rounded-lg shadow hover:bg-gray-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <!-- Notification Panel -->
                <div id="notificationPanel" class="absolute right-0 mt-2 w-screen max-w-xs sm:w-80 bg-white rounded-lg shadow-xl hidden z-50 mx-4 sm:mx-0">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="font-semibold text-gray-800">Notifications</h3>
                        <button onclick="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-800">Mark all read</button>
                    </div>
                    <div id="notificationList" class="max-h-64 overflow-y-auto">
                        <p class="p-4 text-gray-500 text-sm">No notifications</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Task Form -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-8 border-t-4 border-blue-600">
            <h2 class="text-xl font-semibold mb-4">Add New Task</h2>
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                <input type="text" id="taskName" placeholder="Task Name" class="w-full sm:flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="number" id="taskInterval" placeholder="Interval (min)" class="w-full sm:w-32 p-2 border rounded" value="60">
                <button onclick="addTask()" class="bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700 whitespace-nowrap transition-colors">Add Task</button>
            </div>
        </div>

        <!-- Agent Ping Back Section -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-8 border-t-4 border-green-600">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Agent Ping Back
            </h2>
            <div id="agentStatusList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Agent cards will be dynamically inserted here -->
            </div>
        </div>

        <!-- Ruto's Auto-Task Detection Rules -->
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-8 border-t-4 border-purple-600">
            <button onclick="toggleHelpPanel()" class="w-full flex justify-between items-center text-left">
                <h2 class="text-xl font-semibold flex items-center gap-2">
                    <span class="text-2xl">ðŸ—¿</span>
                    Ruto's Auto-Task Detection Rules
                </h2>
                <svg id="helpPanelChevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div id="helpPanel" class="hidden mt-4 space-y-4">
                <!-- Trigger Conditions -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Auto-Create Task When:
                    </h3>
                    <ul class="text-sm text-gray-700 space-y-1 ml-7 list-disc">
                        <li><strong>Multi-step work</strong> â€” Any request requiring 3+ actions</li>
                        <li><strong>Time investment</strong> â€” Work estimated to take 15+ minutes</li>
                        <li><strong>Project phases</strong> â€” Requests mentioning phases, milestones, or stages</li>
                        <li><strong>Recurring work</strong> â€” Tasks that need periodic attention</li>
                        <li><strong>Explicit request</strong> â€” "track this", "create a task", "add to tracker"</li>
                    </ul>
                </div>
                
                <!-- Skip Conditions -->
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Skip Task Creation When:
                    </h3>
                    <ul class="text-sm text-gray-700 space-y-1 ml-7 list-disc">
                        <li>Simple questions (single answer)</li>
                        <li>Quick lookups (read file, check status)</li>
                        <li>Casual conversation</li>
                        <li>Immediate one-step actions</li>
                    </ul>
                </div>
                
                <!-- Task Template -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-blue-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Task Creation Template:
                    </h3>
                    <pre class="text-xs text-gray-700 bg-white p-3 rounded border overflow-x-auto"><code>{
  "name": "[Clear action-oriented title]",
  "priority": "medium",  // high if urgent/important
  "phases": [...],       // Break into steps if complex
  "description": "Context and goal"
}</code></pre>
                </div>
                
                <!-- Update Triggers -->
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <h3 class="font-bold text-yellow-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Auto-Update Triggers:
                    </h3>
                    <ul class="text-sm text-gray-700 space-y-1 ml-7 list-disc">
                        <li><strong>Start work</strong> â†’ Set status to <code class="bg-gray-200 px-1 rounded">in_progress</code></li>
                        <li><strong>Complete milestone</strong> â†’ Mark phase/todo done, add comment</li>
                        <li><strong>Finish task</strong> â†’ Set status to <code class="bg-gray-200 px-1 rounded">done</code>, add summary</li>
                        <li><strong>Blockers</strong> â†’ Add comment explaining issue</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Task Columns -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Todo Column -->
            <div>
                <h3 class="font-bold text-gray-600 mb-4 uppercase tracking-wider flex items-center">
                    <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span> To Do <span id="todoCount" class="ml-2 px-2 py-0.5 text-xs bg-gray-200 text-gray-700 rounded-full"></span>
                </h3>
                <div id="todoList" class="space-y-4"></div>
            </div>
            <!-- In Progress Column -->
            <div>
                <h3 class="font-bold text-blue-600 mb-4 uppercase tracking-wider flex items-center">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span> In Progress <span id="inProgressCount" class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full"></span>
                </h3>
                <div id="inProgressList" class="space-y-4"></div>
            </div>
            <!-- Done Column -->
            <div>
                <h3 class="font-bold text-green-600 mb-4 uppercase tracking-wider flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span> Done <span id="doneCount" class="ml-2 px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full"></span>
                    </div>
                    <span id="doneLimit" class="text-xs text-gray-400 font-normal hidden">Showing latest 5</span>
                </h3>
                <div id="doneList" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full flex flex-col modal-content">
            <div class="p-6 border-b flex justify-between items-start">
                <div>
                    <h3 id="modalTaskName" class="text-2xl font-bold text-gray-800">Task Details</h3>
                    <div id="modalTaskMeta" class="flex gap-2 mt-1"></div>
                </div>
                <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <!-- Description -->
                <section>
                    <h4 class="text-sm font-bold text-gray-500 uppercase tracking-tight mb-2">Description</h4>
                    <p id="modalDescription" class="text-gray-700 whitespace-pre-wrap"></p>
                </section>

                <!-- Flow Chart -->
                <section id="flowChartSection" class="hidden">
                    <h4 class="text-sm font-bold text-gray-500 uppercase tracking-tight mb-2">Workflow</h4>
                    <div id="mermaidChart" class="bg-gray-50 rounded border p-4 flex justify-center"></div>
                </section>

                <!-- Phases & Todos -->
                <section>
                    <h4 class="text-sm font-bold text-gray-500 uppercase tracking-tight mb-3">Phases & Checklists</h4>
                    <div id="phasesList" class="space-y-4"></div>
                </section>

                <!-- Comments -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-gray-500 uppercase tracking-tight">Audit Log</h4>
                        <button onclick="addCommentPrompt()" class="text-xs text-blue-600 hover:underline">+ Add Note</button>
                    </div>
                    <div id="commentsList" class="space-y-2 bg-gray-50 p-4 rounded border max-h-48 overflow-y-auto"></div>
                </section>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-between items-center">
                <div class="flex gap-2">
                    <button id="modalActionBtn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700"></button>
                    <button onclick="deleteCurrentTask()" class="text-red-600 px-4 py-2 rounded text-sm font-medium hover:bg-red-50 border border-red-200">Delete Task</button>
                </div>
                <span id="modalTaskId" class="text-xs text-gray-400"></span>
            </div>
        </div>
    </div>

    <!-- Edit Basic Info Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Edit Task</h3>
            <input type="hidden" id="editTaskId">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Task Name</label>
                <input type="text" id="editTaskName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="editTaskDescription" rows="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Task description..."></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select id="editTaskPriority" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Interval (minutes)</label>
                    <input type="number" id="editTaskInterval" class="w-full p-2 border rounded">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agent Skills <span class="text-gray-400 text-xs">(comma-separated)</span></label>
                    <textarea id="editTaskAgentSkills" rows="2" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g., opencode-controller, github"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Skills <span class="text-gray-400 text-xs">(comma-separated)</span></label>
                    <textarea id="editTaskTaskSkills" rows="2" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="e.g., nano-banana-pro, database"></textarea>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Flowchart / Diagram <span class="text-gray-400 text-xs">(Mermaid syntax)</span></label>
                <textarea id="editTaskFlowchart" rows="4" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none text-xs font-mono" placeholder="graph TD
    A[Start] --> B[Plan]
    B --> C[Build]
    C --> D[Done]"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Agent</label>
                <select id="edit-task-agent" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="">Unassigned</option>
                </select>
            </div>
            
            <div class="flex justify-end gap-2">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded transition-colors">Cancel</button>
                <button onclick="saveTaskEdit()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/tasks/';
        let currentTaskId = null;
        let agentsList = [];
        let showingAllDone = true;

        // Helper functions for parsing and combining skills
        function parseSkills(skillsString) {
            if (!skillsString || !skillsString.trim()) {
                return { agentSkills: [], taskSkills: [] };
            }
            
            const skills = skillsString.split(',').map(s => s.trim()).filter(Boolean);
            const agentSkills = [];
            const taskSkills = [];
            
            skills.forEach(skill => {
                if (skill.toLowerCase().startsWith('agent:')) {
                    agentSkills.push(skill.substring(6).trim());
                } else if (skill.toLowerCase().startsWith('task:')) {
                    taskSkills.push(skill.substring(5).trim());
                } else {
                    // Default to task skills if no prefix
                    taskSkills.push(skill);
                }
            });
            
            return { agentSkills, taskSkills };
        }

        function combineSkills(agentSkills, taskSkills) {
            const skills = [];
            
            if (agentSkills && agentSkills.length > 0) {
                agentSkills.forEach(skill => {
                    if (skill.trim()) {
                        skills.push('agent:' + skill.trim());
                    }
                });
            }
            
            if (taskSkills && taskSkills.length > 0) {
                taskSkills.forEach(skill => {
                    if (skill.trim()) {
                        skills.push('task:' + skill.trim());
                    }
                });
            }
            
            return skills.join(',');
        }

        function showAllDone() {
            showingAllDone = true;
            fetchTasks();
        }

        function hideOldDone() {
            showingAllDone = false;
            fetchTasks();
        }

        async function fetchTasks() {
            try {
                const response = await fetch(API_URL);
                const tasks = await response.json();
                
                const lists = {
                    todo: document.getElementById('todoList'),
                    in_progress: document.getElementById('inProgressList'),
                    done: document.getElementById('doneList')
                };

                // Clear lists
                Object.values(lists).forEach(list => list.innerHTML = '');

                // Separate done tasks, sort by most recent
                const allDoneTasks = tasks.filter(t => t.status === 'done')
                    .sort((a, b) => new Date(b.last_ping || b.created_at) - new Date(a.last_ping || a.created_at));
                
                // Show all or just 5 based on toggle state
                const doneTasks = showingAllDone ? allDoneTasks : allDoneTasks.slice(0, 5);
                const otherTasks = tasks.filter(t => t.status !== 'done');

                // Update count badges
                document.getElementById('todoCount').textContent = otherTasks.filter(t => t.status === 'todo').length;
                document.getElementById('inProgressCount').textContent = otherTasks.filter(t => t.status === 'in_progress').length;
                document.getElementById('doneCount').textContent = allDoneTasks.length;
                
                // Show toggle indicator if there are more than 5 done tasks
                const doneLimitEl = document.getElementById('doneLimit');
                if (allDoneTasks.length > 5) {
                    doneLimitEl.classList.remove('hidden');
                    if (showingAllDone) {
                        doneLimitEl.innerHTML = `<span class="text-gray-600">Showing all ${allDoneTasks.length}</span> <button onclick="hideOldDone()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs font-medium ml-2 transition-colors">Show latest 5</button>`;
                    } else {
                        doneLimitEl.innerHTML = `<span class="text-gray-600">Showing latest 5 of ${allDoneTasks.length}</span> <button onclick="showAllDone()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs font-medium ml-2 transition-colors">View all</button>`;
                    }
                } else {
                    doneLimitEl.classList.add('hidden');
                }

                // Render done tasks
                doneTasks.forEach(task => {
                    const card = createTaskCard(task);
                    lists.done.appendChild(card);
                });

                // Render other tasks
                otherTasks.forEach(task => {
                    const card = createTaskCard(task);
                    const container = lists[task.status] || lists.todo;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error("Fetch failed:", e);
            }
        }

        function createTaskCard(task) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow hover:shadow-md transition-all border-l-4 ' + getStatusColor(task.status) + ' cursor-pointer group relative flex flex-col h-full';
            div.onclick = (e) => {
                if (!e.target.closest('button')) openTaskDetails(task.id);
            };
            
            // Ping Indicator Logic
            let pingIndicator = '';
            if (task.unread_reminder_count > 0) {
                const colorClass = task.unread_reminder_count === 1 ? 'bg-yellow-400' : 'bg-red-500 pulse-red';
                const tooltip = task.unread_reminder_count === 1 ? '1 unread ping' : `${task.unread_reminder_count} unread pings`;
                pingIndicator = `
                    <div class="absolute -top-2 -left-2 h-4 w-4 ${colorClass} rounded-full border-2 border-white shadow-sm z-10" title="${tooltip}"></div>
                `;
            }

            const progress = task.progress_percent || 0;
            const priorityColors = {
                'low': 'bg-gray-100 text-gray-600',
                'medium': 'bg-blue-50 text-blue-600',
                'high': 'bg-orange-50 text-orange-600',
                'critical': 'bg-red-50 text-red-600'
            };
            const pColor = priorityColors[task.priority] || priorityColors.medium;

            // Agent & Skills Logic
            const agentDisplay = task.agent_name ? 
                `<div class="flex items-center gap-1 text-[10px] text-gray-500 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>${task.agent_name}</span>
                 </div>` : '';

            const { agentSkills, taskSkills } = parseSkills(task.skills);
            const allSkills = [...agentSkills.map(s => ({ type: 'agent', name: s })), ...taskSkills.map(s => ({ type: 'task', name: s }))];
            
            const skillsDisplay = allSkills.length > 0 ? 
                `<div class="flex flex-wrap gap-1 mb-3">
                    ${allSkills.slice(0, 3).map(s => {
                        const bgClass = s.type === 'agent' ? 'bg-indigo-100' : 'bg-amber-100';
                        const textClass = s.type === 'agent' ? 'text-indigo-700' : 'text-amber-700';
                        return `<span class="px-2 py-0.5 ${bgClass} ${textClass} text-[9px] rounded-full font-medium">${s.name}</span>`;
                    }).join('')}
                    ${allSkills.length > 3 ? `<span class="text-[9px] text-gray-400">+${allSkills.length - 3}</span>` : ''}
                 </div>` : '';

            div.innerHTML = `
                ${pingIndicator}
                ${agentDisplay}
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-gray-800 flex-1 min-w-0 break-words group-hover:text-blue-600 transition-colors text-sm">${task.name}</h4>
                    <span class="text-[9px] uppercase font-bold px-2 py-0.5 rounded-full ${pColor} ml-2 flex-shrink-0">${task.priority || 'medium'}</span>
                </div>
                
                ${task.description ? `<p class="text-xs text-gray-500 line-clamp-2 mb-2">${task.description}</p>` : ''}
                
                ${skillsDisplay}

                <div class="mt-auto pt-2">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>Progress</span>
                        <span>${progress}%</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-blue-500 h-full rounded-full progress-bar" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2 mt-2 border-t border-gray-50">
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); openEditModal(${task.id}, '${task.name.replace(/'/g, "\\'")}', ${task.interval_minutes})" 
                                class="text-[10px] font-bold text-gray-400 hover:text-blue-600 flex items-center uppercase transition-colors">
                            Edit
                        </button>
                    </div>
                    <span class="text-[10px] font-mono text-gray-300">#${task.id}</span>
                </div>
            `;
            return div;
        }

        function getStatusColor(status) {
            if (status === 'todo') return 'border-gray-200';
            if (status === 'in_progress') return 'border-blue-500';
            if (status === 'done') return 'border-green-500';
            return 'border-gray-200';
        }

        async function openTaskDetails(taskId) {
            currentTaskId = taskId;
            try {
                const response = await fetch(`${API_URL}${taskId}`);
                const task = await response.json();
                
                document.getElementById('modalTaskName').textContent = task.name;
                document.getElementById('modalTaskId').textContent = `Task ID: ${task.id}`;
                document.getElementById('modalDescription').textContent = task.description || "No description provided.";
                
                // Tags, Priority, Agent, Skills
                const meta = document.getElementById('modalTaskMeta');
                meta.innerHTML = `<span class="text-xs uppercase font-bold px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 mr-2">${task.priority}</span>`;
                
                if (task.agent_name) {
                    meta.innerHTML += `<span class="text-xs text-gray-600 px-2 py-0.5 rounded-full bg-gray-100 border border-gray-200 mr-2 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        ${task.agent_name}
                    </span>`;
                }

                if (task.skills) {
                    const { agentSkills, taskSkills } = parseSkills(task.skills);
                    
                    if (agentSkills.length > 0) {
                        meta.innerHTML += '<span class="text-[10px] text-gray-400 mr-1">Agent Skills:</span>';
                        agentSkills.forEach(skill => {
                            meta.innerHTML += `<span class="text-xs text-indigo-700 px-2 py-0.5 rounded-full bg-indigo-100 mr-1">${skill.trim()}</span>`;
                        });
                    }
                    
                    if (taskSkills.length > 0) {
                        if (agentSkills.length > 0) meta.innerHTML += '<br class="mb-1">';
                        meta.innerHTML += '<span class="text-[10px] text-gray-400 mr-1">Task Skills:</span>';
                        taskSkills.forEach(skill => {
                            meta.innerHTML += `<span class="text-xs text-amber-700 px-2 py-0.5 rounded-full bg-amber-100 mr-1">${skill.trim()}</span>`;
                        });
                    }
                }

                if (task.context_tags) {
                    meta.innerHTML += '<div class="mt-2">';
                    task.context_tags.split(',').forEach(tag => {
                        meta.innerHTML += `<span class="text-xs text-gray-500 px-2 py-0.5 rounded-full bg-gray-100 mr-1">#${tag.trim()}</span>`;
                    });
                    meta.innerHTML += '</div>';
                }

                // Render Phases
                const phasesContainer = document.getElementById('phasesList');
                if (!task.phases || task.phases.length === 0) {
                    phasesContainer.innerHTML = '<p class="text-xs text-gray-400 italic">No phases defined for this task.</p>';
                } else {
                    phasesContainer.innerHTML = task.phases.sort((a,b) => a.order - b.order).map(phase => `
                        <div class="border rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b">
                                <div class="flex justify-between items-center mb-1">
                                    <h5 class="text-sm font-bold text-gray-700">${phase.name}</h5>
                                    <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${getPhaseStatusClass(phase.status)}">${phase.status.replace('_', ' ')}</span>
                                </div>
                                ${phase.description ? `<p class="text-xs text-gray-500">${phase.description}</p>` : ''}
                            </div>
                            <div class="p-3 space-y-3">
                                ${phase.todos.map(todo => `
                                    <div class="flex items-start gap-3">
                                        <input type="checkbox" ${todo.status === 'done' ? 'checked' : ''} 
                                               onchange="toggleTodo(${todo.id}, this.checked)"
                                               class="w-4 h-4 mt-0.5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer flex-shrink-0">
                                        <div>
                                            <span class="text-sm block ${todo.status === 'done' ? 'text-gray-400 line-through' : 'text-gray-700'}">${todo.name}</span>
                                            ${todo.description ? `<p class="text-xs text-gray-400 mt-0.5">${todo.description}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-xs text-gray-400 italic">No items</p>'}
                            </div>
                        </div>
                    `).join('');
                }

                // Render Comments
                const commentsContainer = document.getElementById('commentsList');
                if (!task.comments || task.comments.length === 0) {
                    commentsContainer.innerHTML = '<p class="text-xs text-gray-400 italic">No log entries yet.</p>';
                } else {
                    commentsContainer.innerHTML = task.comments.reverse().map(comment => `
                        <div class="text-[11px] border-b border-gray-100 pb-2 mb-2 last:border-0 last:mb-0 last:pb-0">
                            <div class="flex justify-between font-bold text-gray-500 mb-0.5">
                                <span>${comment.author.toUpperCase()}</span>
                                <span>${new Date(comment.timestamp).toLocaleString()}</span>
                            </div>
                            <p class="text-gray-700">${comment.text}</p>
                        </div>
                    `).join('');
                }

                // Mermaid Chart
                const flowSection = document.getElementById('flowChartSection');
                const chartDiv = document.getElementById('mermaidChart');
                if (task.flow_chart) {
                    flowSection.classList.remove('hidden');
                    // Clear previous content and reset mermaid
                    chartDiv.innerHTML = '';
                    chartDiv.removeAttribute('data-processed');
                    
                    // Create a unique ID for this chart
                    const chartId = 'mermaid-chart-' + Date.now();
                    
                    try {
                        // Render mermaid chart
                        const { svg } = await mermaid.render(chartId, task.flow_chart);
                        chartDiv.innerHTML = svg;
                    } catch (err) {
                        console.error('Mermaid render error:', err);
                        chartDiv.innerHTML = `<p class="text-red-500 text-xs">Error rendering chart</p><pre class="text-[10px] overflow-auto mt-2 bg-gray-100 p-2 rounded">${task.flow_chart}</pre>`;
                    }
                } else {
                    flowSection.classList.add('hidden');
                }

                // Action Button Logic
                const btn = document.getElementById('modalActionBtn');
                if (task.status === 'todo') {
                    btn.textContent = "Start Task";
                    btn.onclick = () => updateStatus(task.id, 'in_progress', true);
                    btn.classList.remove('hidden');
                } else if (task.status === 'in_progress') {
                    btn.textContent = "Finish Task";
                    btn.onclick = () => updateStatus(task.id, 'done', true);
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }

                document.getElementById('detailsModal').classList.remove('hidden');
            } catch (e) {
                console.error("Details fetch failed:", e);
            }
        }

        function getPhaseStatusClass(status) {
            switch(status) {
                case 'completed': return 'bg-green-100 text-green-700';
                case 'in_progress': return 'bg-blue-100 text-blue-700';
                case 'blocked': return 'bg-red-100 text-red-700';
                default: return 'bg-gray-100 text-gray-700';
            }
        }

        async function toggleTodo(todoId, isDone) {
            const status = isDone ? 'done' : 'todo';
            try {
                await fetch(`/todos/${todoId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                // Refresh modal data to show propagation changes
                if (currentTaskId) openTaskDetails(currentTaskId);
                fetchTasks();
            } catch (e) {
                console.error("Todo update failed:", e);
            }
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            currentTaskId = null;
        }

        async function addTask() {
            const name = document.getElementById('taskName').value;
            const interval = document.getElementById('taskInterval').value;
            if (!name) return alert('Name is required');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, interval_minutes: parseFloat(interval) })
                });
                
                if (response.status === 401) {
                    alert("Unauthorized: Only the Assistant can create tasks via API.");
                    return;
                }

                document.getElementById('taskName').value = '';
                fetchTasks();
            } catch (e) {
                console.error("Add failed:", e);
            }
        }

        async function updateStatus(taskId, status, fromModal = false) {
            try {
                await fetch(`${API_URL}${taskId}?status=${status}`, { method: 'PATCH' });
                if (fromModal) openTaskDetails(taskId);
                fetchTasks();
            } catch (e) {
                console.error("Status update failed:", e);
            }
        }

        async function deleteCurrentTask() {
            if (!currentTaskId || !confirm('Are you sure you want to delete this task?')) return;
            try {
                await fetch(`${API_URL}${currentTaskId}`, { method: 'DELETE' });
                closeDetailsModal();
                fetchTasks();
            } catch (e) {
                console.error("Delete failed:", e);
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            await fetch(`${API_URL}${taskId}`, { method: 'DELETE' });
            fetchTasks();
        }

        async function openEditModal(taskId, name, interval) {
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskName').value = name;
            document.getElementById('editTaskInterval').value = interval;
            
            // Fetch task details to populate all fields
            try {
                const response = await fetch(`${API_URL}${taskId}`);
                const task = await response.json();
                document.getElementById('editTaskDescription').value = task.description || '';
                document.getElementById('editTaskPriority').value = task.priority || 'medium';
                const { agentSkills, taskSkills } = parseSkills(task.skills || '');
                document.getElementById('editTaskAgentSkills').value = agentSkills.join(', ');
                document.getElementById('editTaskTaskSkills').value = taskSkills.join(', ');
                document.getElementById('editTaskFlowchart').value = task.flow_chart || '';
                document.getElementById('edit-task-agent').value = task.assigned_agent_id || '';
            } catch (e) {
                console.error("Failed to fetch task details for editing:", e);
                document.getElementById('editTaskDescription').value = '';
                document.getElementById('editTaskPriority').value = 'medium';
                document.getElementById('editTaskAgentSkills').value = '';
                document.getElementById('editTaskTaskSkills').value = '';
                document.getElementById('editTaskFlowchart').value = '';
                document.getElementById('edit-task-agent').value = '';
            }
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveTaskEdit() {
            const taskId = document.getElementById('editTaskId').value;
            const name = document.getElementById('editTaskName').value;
            const description = document.getElementById('editTaskDescription').value;
            const priority = document.getElementById('editTaskPriority').value;
            const interval = document.getElementById('editTaskInterval').value;
            const agentSkills = document.getElementById('editTaskAgentSkills').value.split(',').map(s => s.trim()).filter(Boolean);
            const taskSkills = document.getElementById('editTaskTaskSkills').value.split(',').map(s => s.trim()).filter(Boolean);
            const skills = combineSkills(agentSkills, taskSkills);
            const flowchart = document.getElementById('editTaskFlowchart').value;
            const agentId = document.getElementById('edit-task-agent').value;

            if (!name) return alert('Name is required');

            const body = {
                name,
                description,
                priority,
                interval_minutes: parseFloat(interval),
                skills,
                flow_chart: flowchart,
                agent_id: agentId || null
            };

            try {
                await fetch(`${API_URL}${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                closeEditModal();
                fetchTasks();
                if (currentTaskId == taskId) openTaskDetails(taskId);
            } catch (e) {
                console.error("Failed to save task edit:", e);
            }
        }

        async function addCommentPrompt() {
            const text = prompt("Enter log message:");
            if (!text || !currentTaskId) return;
            
            await fetch(`${API_URL}${currentTaskId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author: 'user' })
            });
            openTaskDetails(currentTaskId);
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailsModal();
        });

        // Notification functions
        let notificationsOpen = false;

        async function fetchNotifications() {
            try {
                const response = await fetch('/notifications/?unread_only=true');
                const notifications = await response.json();
                updateNotificationUI(notifications);
            } catch (e) {
                console.error('Failed to fetch notifications:', e);
            }
        }

        function updateNotificationUI(notifications) {
            const badge = document.getElementById('notificationBadge');
            const list = document.getElementById('notificationList');
            
            if (notifications.length > 0) {
                badge.textContent = notifications.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            if (notifications.length === 0) {
                list.innerHTML = '<p class="p-4 text-gray-500 text-sm">No notifications</p>';
            } else {
                list.innerHTML = notifications.map(n => `
                    <div class="p-3 border-b hover:bg-gray-50 ${n.is_read ? 'opacity-60 bg-gray-50' : ''}">
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-medium text-gray-800 ${n.is_read ? 'text-gray-500' : ''}">${n.task_name}</p>
                            <span class="text-xs text-gray-400">${new Date(n.created_at).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1 ${n.is_read ? 'text-gray-400' : ''}">${n.message}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[10px] px-2 py-1 rounded ${n.notification_type === 'reminder' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${n.notification_type}</span>
                            ${!n.is_read ? `<button onclick="event.stopPropagation(); markNotificationAsRead(${n.id})" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Mark as read</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            notificationsOpen = !notificationsOpen;
            if (notificationsOpen) {
                panel.classList.remove('hidden');
                fetchNotifications();
            } else {
                panel.classList.add('hidden');
            }
        }

        function toggleHelpPanel() {
            const panel = document.getElementById('helpPanel');
            const chevron = document.getElementById('helpPanelChevron');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                panel.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        async function markAllAsRead() {
            await fetch('/notifications/read-all', { method: 'POST' });
            fetchNotifications();
        }

        async function markNotificationAsRead(notificationId) {
            try {
                await fetch(`/notifications/${notificationId}/read`, { method: 'PATCH' });
                fetchNotifications();
                fetchTasks();
            } catch (e) {
                console.error('Failed to mark notification as read:', e);
            }
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('notificationPanel');
            const bell = e.target.closest('button');
            if (!notificationsOpen) return;
            if (!bell && !panel.contains(e.target)) {
                panel.classList.add('hidden');
                notificationsOpen = false;
            }
        });

        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false });

        // Agent Status Functions
        async function fetchAgents() {
            try {
                const response = await fetch('/agents/');
                const agents = await response.json();
                agentsList = agents;
                renderAgentCards(agents);
                populateAgentDropdown(agents);
            } catch (e) {
                console.error("Failed to fetch agents:", e);
                const container = document.getElementById('agentStatusList');
                container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Failed to load agent status</p>';
            }
        }

        function renderAgentCards(agents) {
            const container = document.getElementById('agentStatusList');
            
            if (!agents || agents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">No agents found</p>';
                return;
            }

            // Only show agents with active (in_progress) tasks
            const activeAgents = agents.filter(agent => agent.current_task_name);
            
            if (activeAgents.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm col-span-full italic">No agents with active tasks</p>';
                return;
            }

            container.innerHTML = activeAgents.map(agent => {
                const statusColors = {
                    'online': 'bg-green-100 text-green-800 border-green-200',
                    'offline': 'bg-red-100 text-red-800 border-red-200',
                    'busy': 'bg-yellow-100 text-yellow-800 border-yellow-200'
                };
                const statusColor = statusColors[agent.status] || statusColors.offline;
                
                return `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow ${statusColor}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-gray-800 text-sm">${agent.name}</h3>
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${agent.status}</span>
                        </div>
                        ${agent.current_task_name ? `
                            <div class="text-xs text-gray-600">
                                <span class="font-medium">Current Task:</span>
                                <p class="truncate mt-1">${agent.current_task_name}</p>
                            </div>
                        ` : '<p class="text-xs text-gray-400 italic">No active task</p>'}
                    </div>
                `;
            }).join('');
        }

        function populateAgentDropdown(agents) {
            const dropdown = document.getElementById('edit-task-agent');
            dropdown.innerHTML = '<option value="">Unassigned</option>';
            
            if (agents && agents.length > 0) {
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.name;
                    dropdown.appendChild(option);
                });
            }
        }

        // Initial fetch
        fetchTasks();
        fetchNotifications();
        fetchAgents();
        // Refresh every 30 seconds
        setInterval(fetchTasks, 30000);
        setInterval(fetchNotifications, 30000);
        setInterval(fetchAgents, 30000);
    </script>
</body>
</html>
